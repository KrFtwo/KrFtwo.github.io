<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>FFmpeg.wasm 视频转换器 (稳定版)</title>
    <style>
        /* 样式保持不变 */
        body { max-width: 800px; margin: 20px auto; padding: 20px; font-family: Arial; }
        #progressBar { width: 100%; height: 20px; background: #f0f0f0; margin: 10px 0; display: none; }
        #progress { width: 0%; height: 100%; background: #4CAF50; transition: width 0.3s; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
    </style>
</head>
<body>
    <h1>视频转MP4转换器</h1>
    <input type="file" id="videoInput" accept="video/*" />
    <button id="convertBtn" onclick="startConversion()" disabled>开始转换</button>
    <div id="progressBar"><div id="progress"></div></div>
    <div id="status">初始化中...</div>
    <a id="downloadLink" style="display: none;">下载MP4</a>

    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.0/dist/ffmpeg.min.js"></script>
    <script>
        // 初始化配置
        const { createFFmpeg, fetchFile } = FFmpeg;
        const ffmpeg = createFFmpeg({
            corePath: 'https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js',
            log: true
        });

        // DOM元素
        const elements = {
            videoInput: document.getElementById('videoInput'),
            convertBtn: document.getElementById('convertBtn'),
            status: document.getElementById('status'),
            progressBar: document.getElementById('progressBar'),
            progress: document.getElementById('progress'),
            downloadLink: document.getElementById('downloadLink')
        };

        // 初始化加载
        (async () => {
            try {
                elements.status.textContent = '正在加载FFmpeg核心...';
                await ffmpeg.load();
                elements.status.textContent = '就绪 - 请选择视频文件';
                elements.convertBtn.disabled = false;
            } catch (error) {
                showError(`初始化失败: ${error.message}`);
            }
        })();

        // 转换函数
        async function startConversion() {
            const file = elements.videoInput.files[0];
            if (!file) return alert('请先选择视频文件');

            try {
                // 重置状态
                elements.convertBtn.disabled = true;
                elements.progressBar.style.display = 'block';
                elements.status.textContent = '准备转换...';

                // 设置进度监听
                ffmpeg.setProgress(({ ratio }) => {
                    const percent = Math.round(ratio * 100);
                    elements.progress.style.width = `${percent}%`;
                    elements.status.textContent = `转换进度: ${percent}%`;
                });

                // 执行转换
                ffmpeg.FS('writeFile', file.name, await fetchFile(file));
                await ffmpeg.run(
                    '-i', file.name,
                    '-c:v', 'libx264', '-preset', 'fast', '-crf', '23',
                    '-c:a', 'aac', '-b:a', '128k',
                    'output.mp4'
                );

                // 生成下载链接
                const data = ffmpeg.FS('readFile', 'output.mp4');
                const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
                
                elements.downloadLink.href = url;
                elements.downloadLink.download = 'converted.mp4';
                elements.downloadLink.style.display = 'inline';
                elements.status.textContent = '转换完成！';
            } catch (error) {
                showError(`转换失败: ${error.message}`);
            } finally {
                elements.convertBtn.disabled = false;
                elements.progressBar.style.display = 'none';
                elements.progress.style.width = '0%';
            }
        }

        // 错误处理
        function showError(msg) {
            elements.status.textContent = msg;
            elements.status.style.color = 'red';
            setTimeout(() => elements.status.style.color = 'black', 5000);
        }

        // 文件选择监听
        elements.videoInput.addEventListener('change', () => {
            if (elements.videoInput.files[0]) {
                elements.status.textContent = `已选择: ${elements.videoInput.files[0].name}`;
            }
        });
    </script>
</body>
</html>