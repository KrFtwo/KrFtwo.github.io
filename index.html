<!DOCTYPE html>
<html>
<head>
    <title>视频转换器</title>
</head>
<body>
    <h1>视频转 MP4 转换器</h1>
    
    <!-- 文件上传输入 -->
    <input type="file" id="uploader" accept="video/*" />
    <button onclick="convert()" id="convertBtn">开始转换</button>
    
    <!-- 状态和结果 -->
    <div id="status"></div>
    <a id="downloadLink" style="display: none;">下载 MP4</a>

    <!-- 引入 ffmpeg.wasm -->
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.4/dist/ffmpeg.min.js"></script>
    <script>
        const { createFFmpeg, fetchFile } = FFmpeg;
        let ffmpeg = null;

        // 初始化 FFmpeg
        async function initFFmpeg() {
            ffmpeg = createFFmpeg({
                log: true,
                corePath: 'https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js'
            });
            
            document.getElementById('status').textContent = '加载 FFmpeg...';
            await ffmpeg.load();
            document.getElementById('status').textContent = '准备就绪';
        }

        // 转换函数
        async function convert() {
            const input = document.getElementById('uploader').files[0];
            if (!input) {
                alert('请先选择文件');
                return;
            }

            try {
                const btn = document.getElementById('convertBtn');
                btn.disabled = true;
                document.getElementById('status').textContent = '转换中...';

                // 写入输入文件
                ffmpeg.FS('writeFile', input.name, await fetchFile(input));

                // 执行转换命令
                await ffmpeg.run(
                    '-i', input.name,       // 输入文件
                    '-c:v', 'libx264',      // 视频编码器
                    '-preset', 'fast',      // 编码预设
                    '-crf', '23',           // 质量参数
                    '-c:a', 'aac',          // 音频编码器
                    '-b:a', '128k',         // 音频比特率
                    'output.mp4'            // 输出文件名
                );

                // 读取结果
                const data = ffmpeg.FS('readFile', 'output.mp4');
                
                // 创建下载链接
                const url = URL.createObjectURL(
                    new Blob([data.buffer], { type: 'video/mp4' })
                );
                
                const link = document.getElementById('downloadLink');
                link.href = url;
                link.download = 'converted.mp4';
                link.style.display = 'block';
                document.getElementById('status').textContent = '转换完成！';
            } catch (err) {
                console.error(err);
                document.getElementById('status').textContent = '转换失败: ' + err.message;
            } finally {
                btn.disabled = false;
            }
        }

        // 页面加载时初始化
        initFFmpeg();
    </script>
</body>
</html>